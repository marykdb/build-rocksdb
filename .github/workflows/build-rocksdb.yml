name: Build RocksDB

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  linux-x64:
    name: Linux x86_64
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build legacy toolchain container image
        run: docker build -t rocksdb-linux-legacy -f docker/linux-legacy.Dockerfile .
      - name: Build Linux x86_64 package
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            rocksdb-linux-legacy \
            bash -lc './build.sh linuxX64'
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-linux-x86_64
          path: build/archives/rocksdb-linux-x86_64.zip

  linux-arm64:
    name: Linux ARM64
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build legacy toolchain container image
        run: docker build -t rocksdb-linux-legacy -f docker/linux-legacy.Dockerfile .
      - name: Build Linux ARM64 package
        run: |
          docker run --rm \
            -v "$PWD:/workspace" \
            -w /workspace \
            rocksdb-linux-legacy \
            bash -lc './build.sh linuxArm64'
      - name: Ensure release tooling is available
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-linux-arm64
          path: build/archives/rocksdb-linux-arm64.zip

  android-arm32:
    name: Android ARM32
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config autoconf automake libtool curl unzip zip
      - name: Build Android ARM32 package
        run: ./build.sh androidNativeArm32
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-android-arm32
          path: build/archives/rocksdb-android-arm32.zip

  android-arm64:
    name: Android ARM64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config autoconf automake libtool curl unzip zip
      - name: Build Android ARM64 package
        run: ./build.sh androidNativeArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-android-arm64
          path: build/archives/rocksdb-android-arm64.zip

  android-x86:
    name: Android x86
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config autoconf automake libtool curl unzip zip
      - name: Build Android x86 package
        run: ./build.sh androidNativeX86
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-android-x86
          path: build/archives/rocksdb-android-x86.zip

  android-x64:
    name: Android x86_64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake ninja-build pkg-config autoconf automake libtool curl unzip zip
      - name: Build Android x86_64 package
        run: ./build.sh androidNativeX64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-android-x64
          path: build/archives/rocksdb-android-x64.zip

  mingw-x64:
    name: Windows (MinGW) x86_64
    runs-on: windows-2022
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install build dependencies
        run: |
          choco install -y make ninja
      - name: Install Kotlin/Native MinGW GCC toolchain
        env:
          KONAN_VERSION: 2.2.20
        run: |
          set -euo pipefail
          TOOLCHAIN_DIR="$PWD/toolchains"
          mkdir -p "$TOOLCHAIN_DIR"
          ARCHIVE_NAME="kotlin-native-prebuilt-windows-x86_64-${KONAN_VERSION}.zip"
          ARCHIVE_PATH="$TOOLCHAIN_DIR/${ARCHIVE_NAME}"
          ARCHIVE_URL="https://github.com/JetBrains/kotlin/releases/download/v${KONAN_VERSION}/${ARCHIVE_NAME}"
          echo "Downloading Kotlin/Native toolchain ${KONAN_VERSION} from ${ARCHIVE_URL}"
          curl --fail --location --silent --show-error "$ARCHIVE_URL" --output "$ARCHIVE_PATH"
          if command -v unzip >/dev/null 2>&1; then
            unzip -q "$ARCHIVE_PATH" -d "$TOOLCHAIN_DIR"
          else
            powershell.exe -NoLogo -NoProfile -Command "Expand-Archive -Path '${ARCHIVE_PATH}' -DestinationPath '${TOOLCHAIN_DIR}' -Force"
          fi
          rm -f "$ARCHIVE_PATH"
          KONAN_ROOT="$TOOLCHAIN_DIR/kotlin-native-prebuilt-windows-x86_64-${KONAN_VERSION}"
          TOOLCHAIN_ROOT="$KONAN_ROOT/dependencies/msys2-mingw-w64-x86_64-2"
          if [[ ! -d "$TOOLCHAIN_ROOT" ]]; then
            echo "Expected Kotlin/Native MinGW toolchain at $TOOLCHAIN_ROOT" >&2
            ls -R "$KONAN_ROOT" >&2
            exit 1
          fi
          GCC_MINGW_PREFIX="$TOOLCHAIN_ROOT/mingw64"
          if [[ ! -d "$GCC_MINGW_PREFIX/bin" ]]; then
            echo "Expected MinGW bin directory at $GCC_MINGW_PREFIX/bin" >&2
            exit 1
          fi
          echo "LLVM_MINGW_ROOT=$GCC_MINGW_PREFIX" >> "$GITHUB_ENV"
          echo "MINGW_GCC_SYSROOT=$GCC_MINGW_PREFIX" >> "$GITHUB_ENV"
          echo "$GCC_MINGW_PREFIX/bin" >> "$GITHUB_PATH"
          if [[ -d "$TOOLCHAIN_ROOT/usr/bin" ]]; then
            echo "$TOOLCHAIN_ROOT/usr/bin" >> "$GITHUB_PATH"
          fi
      - name: Build Windows MinGW package
        run: ./build.sh mingwX64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-mingw-x86_64
          path: build/archives/rocksdb-mingw-x86_64.zip

  mingw-arm64:
    name: Windows (MinGW) ARM64
    runs-on: windows-2022
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install build dependencies
        run: |
          choco install -y make ninja
      - name: Install LLVM MinGW toolchain
        run: |
          set -euo pipefail
          LLVM_MINGW_VERSION=20250910
          LLVM_MINGW_DIST=llvm-mingw-${LLVM_MINGW_VERSION}-ucrt-x86_64
          ARCHIVE_NAME="${LLVM_MINGW_DIST}.zip"
          ARCHIVE_PATH="$PWD/${ARCHIVE_NAME}"
          curl -sSL -o "$ARCHIVE_PATH" "https://github.com/mstorsjo/llvm-mingw/releases/download/${LLVM_MINGW_VERSION}/${ARCHIVE_NAME}"
          TOOLCHAIN_DIR="$PWD/toolchains"
          mkdir -p "$TOOLCHAIN_DIR"
          rm -rf "$TOOLCHAIN_DIR/${LLVM_MINGW_DIST}"
          if command -v unzip >/dev/null 2>&1; then
            unzip -q "$ARCHIVE_PATH" -d "$TOOLCHAIN_DIR"
          else
            powershell.exe -NoLogo -NoProfile -Command "Expand-Archive -Path '${ARCHIVE_PATH}' -DestinationPath '${TOOLCHAIN_DIR}' -Force"
          fi
          rm -f "$ARCHIVE_PATH"
          LLVM_MINGW_ROOT="$TOOLCHAIN_DIR/${LLVM_MINGW_DIST}"
          if [[ ! -d "$LLVM_MINGW_ROOT" ]]; then
            echo "Expected toolchain directory $LLVM_MINGW_ROOT not found" >&2
            exit 1
          fi
          echo "LLVM_MINGW_ROOT=$LLVM_MINGW_ROOT" >> "$GITHUB_ENV"
          echo "$LLVM_MINGW_ROOT/bin" >> "$GITHUB_PATH"
      - name: Build Windows ARM64 MinGW package
        run: ./build.sh mingwArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-mingw-arm64
          path: build/archives/rocksdb-mingw-arm64.zip

  macos-x64:
    name: macOS x86_64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build macOS x86_64 package
        run: ./build.sh macosX64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-macos-x86_64
          path: build/archives/rocksdb-macos-x86_64.zip

  macos-arm64:
    name: macOS ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build macOS ARM64 package
        run: ./build.sh macosArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-macos-arm64
          path: build/archives/rocksdb-macos-arm64.zip

  ios-arm64:
    name: iOS ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build iOS ARM64 package
        run: ./build.sh iosArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-ios-arm64
          path: build/archives/rocksdb-ios-arm64.zip

  ios-simulator-arm64:
    name: iOS Simulator ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build iOS Simulator ARM64 package
        run: ./build.sh iosSimulatorArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-ios-simulator-arm64
          path: build/archives/rocksdb-ios-simulator-arm64.zip

  watchos-arm64:
    name: watchOS arm64_32
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build watchOS arm64_32 package
        run: ./build.sh watchosArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-watchos-arm64
          path: build/archives/rocksdb-watchos-arm64.zip

  watchos-device-arm64:
    name: watchOS Device ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build watchOS Device ARM64 package
        run: ./build.sh watchosDeviceArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-watchos-device-arm64
          path: build/archives/rocksdb-watchos-device-arm64.zip

  watchos-simulator-arm64:
    name: watchOS Simulator ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build watchOS Simulator ARM64 package
        run: ./build.sh watchosSimulatorArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-watchos-simulator-arm64
          path: build/archives/rocksdb-watchos-simulator-arm64.zip

  tvos-arm64:
    name: tvOS ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build tvOS ARM64 package
        run: ./build.sh tvosArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-tvos-arm64
          path: build/archives/rocksdb-tvos-arm64.zip

  tvos-simulator-arm64:
    name: tvOS Simulator ARM64
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Build tvOS Simulator ARM64 package
        run: ./build.sh tvosSimulatorArm64
      - uses: actions/upload-artifact@v4
        with:
          name: rocksdb-tvos-simulator-arm64
          path: build/archives/rocksdb-tvos-simulator-arm64.zip

  publish-release:
    name: Publish Release
    needs:
      - linux-x64
      - linux-arm64
      - mingw-x64
      - mingw-arm64
      - macos-x64
      - macos-arm64
      - ios-arm64
      - ios-simulator-arm64
      - watchos-arm64
      - watchos-device-arm64
      - watchos-simulator-arm64
      - tvos-arm64
      - tvos-simulator-arm64
      - android-arm32
      - android-arm64
      - android-x86
      - android-x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - name: List downloaded artifacts
        run: ls -R artifacts
      - name: Determine RocksDB version
        id: rocksdb_version
        run: |
          set -euo pipefail
          version_file="rocksdb/include/rocksdb/version.h"
          if [[ ! -f "$version_file" ]]; then
            echo "RocksDB version header not found at $version_file" >&2
            exit 1
          fi
          version="$(awk '/#define ROCKSDB_MAJOR/{major=$3} /#define ROCKSDB_MINOR/{minor=$3} /#define ROCKSDB_PATCH/{patch=$3} END{if(major==""||minor==""||patch=="") exit 1; printf "%s.%s.%s", major, minor, patch}' "$version_file")"
          if [[ -z "$version" ]]; then
            echo "Failed to parse RocksDB version from $version_file" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"
      - name: Set release metadata
        id: release_metadata
        env:
          ROCKSDB_VERSION: ${{ steps.rocksdb_version.outputs.version }}
        run: |
          set -euo pipefail
          if [[ -z "${ROCKSDB_VERSION}" ]]; then
            echo "RocksDB version is empty" >&2
            exit 1
          fi
          timestamp="$(date +'%Y%m%dT%H%M%S')Z"
          echo "timestamp=$timestamp" >> "$GITHUB_OUTPUT"
          echo "tag=rocksdb-${ROCKSDB_VERSION}-${timestamp}" >> "$GITHUB_OUTPUT"
      - uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
          name: RocksDB ${{ steps.rocksdb_version.outputs.version }} builds ${{ steps.release_metadata.outputs.timestamp }}
          tag_name: ${{ steps.release_metadata.outputs.tag }}
          draft: false
          prerelease: false
